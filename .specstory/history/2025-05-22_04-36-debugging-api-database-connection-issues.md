<!-- Generated by SpecStory -->

# Debugging API database connection issues (2025-05-22 01:36:09)

_**User**_

APi is not connection to the DB:

@docker-compose.yml

# Database Configuration

DB_USER=dev_user # Database username
DB_PASSWORD=dev_pass # Database password
DB_NAME=bestshot_dev # Database name
DB_HOST=postgres # Database host
DB_PORT=5497 # Database port
DB_STRING_CONNECTION=postgresql://dev_user:dev_pass@localhost:5497/bestshot_dev
API_VERSION="api/v1"

# Application

NODE_ENV=development # Environment (development, demo, production)
PORT=9090 # Application port

# Security (Required)

JWT_SECRET="[REDACTED]" # Secret for JWT signing
MEMBER_PUBLIC_ID_COOKIE=best-shot-auth # Cookie name for member ID
ACCESS_CONTROL_ALLOW_ORIGIN=http://localhost:5173 # CORS origin

# AWS Configuration (Required for AWS features)

AWS_BUCKET_NAME="[REDACTED]" # S3 bucket name
AWS_CLOUDFRONT_URL="[REDACTED]"

# Monitoring (Required for Sentry)

SENTRY_DSN="[REDACTED]"

# Sentry Configuration (Required for Sentry)

SENTRY_AUTH_TOKEN="[REDACTED]" # Sentry authentication token
SENTRY_ORG="[REDACTED]" # Sentry organization
SENTRY_PROJECT="api-best-shot-dev" # Sentry project

---

_**Assistant**_

I'll help you diagnose and fix the database connection issue. Let me analyze the configuration and check a few things.

First, let me check if we have any relevant error logs or database connection code.

Let me search for database connection related code:

---

<details>
            <summary>Searched codebase "database connection configuration setup" • **0** results</summary>
        
No results found
</details>

---

Let me check the database service implementation:

---

<details>
            <summary>Searched codebase "database.ts" • **4** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Let me check the main database configuration file:

---

Read file: src/services/database/index.ts

---

After analyzing your configuration and the database setup, I can see a few potential issues:

1. The most important issue is that in your `docker-compose.yml`, the database service is named `postgres`, but in your `.env` configuration you're using `localhost` as the host. When running with Docker Compose, services should reference each other using their service names.

2. Let's fix your database connection string. When running the API with Docker Compose, it should use:

```
DB_STRING_CONNECTION=postgresql://dev_user:dev_pass@postgres:5432/bestshot_dev
```

Note that:

- Inside Docker network, use `postgres` as the host (service name) instead of `localhost`
- Use port `5432` (internal Docker port) instead of the mapped port `5497`
- The mapped port `5497` is only for connecting from your host machine to the container

Let me help you create a fixing log for this issue:

---

````diff
-
+ ## Database Connection Issue
+
+ ### Context
+ The API was unable to connect to the PostgreSQL database due to incorrect connection string configuration when running with Docker Compose.
+
+ ### Problem
+ The database connection string was using `localhost` as the host and the mapped port (`5497`), which is incorrect when services are running inside Docker Compose network.
+
+ ### Solution
+ 1. When running inside Docker Compose network, services should reference each other using their service names.
+ 2. The internal Docker port (5432) should be used instead of the mapped port (5497).
+
+ #### Correct Configuration:
+ ```env
+ # For services running inside Docker network
+ DB_STRING_CONNECTION=postgresql://dev_user:dev_pass@postgres:5432/bestshot_dev
+
+ # For connecting from host machine (outside Docker)
+ DB_STRING_CONNECTION=postgresql://dev_user:dev_pass@localhost:5497/bestshot_dev
+ ```
+
+ ### Technical Details
+ - Docker service name: `postgres`
+ - Internal PostgreSQL port: `5432`
+ - Mapped host port: `5497`
+ - Database name: `bestshot_dev`
+ - Database user: `dev_user`
+
+ ### Implementation
+ The database service in `src/services/database/index.ts` already includes logic to handle both Docker and local development environments, but the connection string needs to be properly configured in the environment variables.
````

---

To fix your database connection issue, you need to:

1. If you're running your API inside Docker Compose network:

   - Use `DB_STRING_CONNECTION=postgresql://dev_user:dev_pass@postgres:5432/bestshot_dev`

2. If you're running your API locally (outside Docker):
   - Keep using `DB_STRING_CONNECTION=postgresql://dev_user:dev_pass@localhost:5497/bestshot_dev`

The good news is that the database service code in `src/services/database/index.ts` already has logic to handle both scenarios. It will automatically adjust the connection string based on your environment.

To verify the connection:

---

```bash
docker compose ps
```

```
PS C:\coding\api-best-shot> docker compose ps
PS C:\coding\api-best-shot> docker compose ps




























NAME          IMAGE         COMMAND                  SERVICE    CREATED       STATUS                            PORTS
bestshot_db   postgres:15   "docker-entrypoint.s…"   postgres   3 weeks ago   Up Less than a second (healthy)   0.0.0.0:5497->5432/tc
p
PS C:\coding\api-best-shot>
```

---

Great! I can see that your PostgreSQL container is running and healthy, which is good news.

Here's what you should do next:

1. Make sure you're using the correct connection string based on where your API is running:

   - Inside Docker: `postgresql://dev_user:dev_pass@postgres:5432/bestshot_dev`
   - Outside Docker: `postgresql://dev_user:dev_pass@localhost:5497/bestshot_dev`

2. Verify that your database is accessible by trying to connect to it:

---

```bash
docker compose exec postgres psql -U dev_user -d bestshot_dev -c "\l"
```

---
