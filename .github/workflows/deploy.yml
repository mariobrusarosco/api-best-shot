name: CI/CD - Deploy Pipeline

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - demo

env:
  NODE_VERSION: '22'
  REGION: us-east1

jobs:
  # Single job that runs everything efficiently
  ci-cd:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable Corepack for Yarn 3.8.7
        run: corepack enable

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Run Quality Checks in Parallel
        run: |
          yarn lint &
          yarn format --check &
          yarn compile &
          yarn test &
          wait

      - name: Check for Migration Changes
        id: migrations
        if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "supabase/migrations/"; then
            echo "has-migrations=true" >> $GITHUB_OUTPUT
          else
            echo "has-migrations=false" >> $GITHUB_OUTPUT
          fi

      - name: Run Migrations
        if: steps.migrations.outputs.has-migrations == 'true'
        run: yarn db:migrate
        env:
          DB_STRING_CONNECTION: ${{ github.event.inputs.environment == 'demo' && secrets.DB_STRING_CONNECTION_DEMO || secrets.DB_STRING_CONNECTION_STAGING }}

      - name: Deploy to Cloud Run
        if: (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && success()
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ github.event.inputs.environment == 'demo' && secrets.GCP_SA_KEY_DEMO || secrets.GCP_SA_KEY_STAGING }}

      - name: Deploy
        if: (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') && success()
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: api-best-shot-${{ github.event.inputs.environment || 'staging' }}
          source: .
          region: ${{ env.REGION }}
          project: api-best-shot-${{ github.event.inputs.environment || 'staging' }}
          flags: |
            --cpu=2
            --memory=2Gi
            --min-instances=0
            --max-instances=10
            --port=8080
            --allow-unauthenticated
            --tag=latest
          env_vars: |
            NODE_ENV=${{ github.event.inputs.environment || 'staging' }}
            API_DOMAIN=api-best-shot-${{ github.event.inputs.environment || 'staging' }}.mariobrusarosco.com
            API_VERSION=/v2
            AWS_REGION=us-east-1
            MEMBER_PUBLIC_ID_COOKIE=best-shot-auth
            ACCESS_CONTROL_ALLOW_ORIGIN=https://best-shot-${{ github.event.inputs.environment || 'staging' }}.mariobrusarosco.com
            AWS_ACCOUNT_ID=905418297381
            AWS_BUCKET_NAME=assets.mariobrusarosco.com
            AWS_CLOUDFRONT_URL=dk57aekjop3j1.cloudfront.net
          secrets: |
            JWT_SECRET=jwt-secret:latest
            DB_STRING_CONNECTION=db-connection-${{ github.event.inputs.environment || 'staging' }}:latest
            AWS_ACCESS_KEY_ID=aws-access-key:latest
            AWS_SECRET_ACCESS_KEY=aws-secret-key:latest
            SENTRY_DSN=sentry-dsn:latest
            INTERNAL_SERVICE_TOKEN=internal-service-token:latest