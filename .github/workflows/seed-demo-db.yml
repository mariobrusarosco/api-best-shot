name: Seed Demo Database

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "yes" to confirm seeding the demo database'
        required: true
        default: 'no'

jobs:
  seed-demo-db:
    if: ${{ github.event.inputs.confirmation == 'yes' }}
    runs-on: ubuntu-latest
    environment: demo

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile --prefer-offline --network-timeout 30000

      - name: Check API Health
        env:
          API_URL: ${{ vars.API_URL || 'https://api-best-shot-demo.mariobrusarosco.com' }}
        run: |
          echo "üîç Checking API health..."
          response=$(curl -s -w "\n%{http_code}" "$API_URL/api/v1/admin/health")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          echo "Health check response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ API is healthy and ready!"
          else
            echo "‚ùå API health check failed with status $http_code"
            exit 1
          fi

      - name: Seed Demo Database via API
        env:
          API_URL: ${{ vars.API_URL || 'https://api-best-shot-demo.mariobrusarosco.com' }}
        run: |
          echo "üå± Calling seeding API endpoint..."
          response=$(curl -s -w "\n%{http_code}" -X POST "$API_URL/api/v1/admin/seed" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Database seeded successfully!"
          else
            echo "‚ùå Seeding failed with status $http_code"
            exit 1
          fi
