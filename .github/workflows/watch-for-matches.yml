name: Updating Tournament Matches on Database

on:
  schedule:
    - cron: '1 0 * * *'
  workflow_dispatch:

jobs:
  watch-for-matches:
    runs-on: ubuntu-latest

    steps:
      - name: Define Tournaments and Make API Calls
        env:
          COOKIE: ${{ secrets.API_COOKIE_DEMO }}
          TOURNAMENT_IDS: ${{ secrets.TOURNAMENT_IDS_DEMO }}
        run: |
          IFS=',' read -r -a TOURNAMENTS <<< "$TOURNAMENT_IDS_DEMO"

          API_URL="https://api-best-shot-demo.mariobrusarosco.com/api/v1/data-provider/matches/"

          curl -X PATCH "$API_URL" \
            -H "Content-Type: application/json" \
            -H "Cookie: $COOKIE" \
            -d "{\"tournamentId\":\"f2adbfb7-d8e5-4500-8395-d313cd4b0896\"}"

          for TOURNAMENT in $TOURNAMENTS
          do
            echo "Calling API for tournament $TOURNAMENT"
            curl -X PATCH "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Cookie: $COOKIE" \
              -d "{\"tournamentId\":\"$TOURNAMENT\"}"

            echo "Waiting 30 minutes before next call..."
            sleep $((30 * 60))
          done
